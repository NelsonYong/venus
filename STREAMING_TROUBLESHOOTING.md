# 流式输出卡住问题排查与解决方案

## 问题现象
流式输出时突然卡住,浏览器控制台出现 403 权限错误:
```
Uncaught (in promise) Object
code: 403
data: {code: 403, msg: 'permission error'}
message: "permission error"
```

## 根本原因

### 1. 浏览器扩展干扰 ⚠️
错误日志显示:
- 请求路径: `/site_integration/template_list`
- 来源: `chrome-extension://...background.js`

**这是一个浏览器扩展程序正在干扰你的应用!**

### 2. 超时设置过短 ⏱️
原配置:
- `maxDuration = 30` 秒
- `AbortSignal.timeout(30000)` = 30 秒

对于复杂查询(特别是启用联网搜索时),30秒可能不够。

## 已实施的修复

### ✅ 1. 延长超时时间
已将超时时间从 30 秒延长到 60 秒:

```typescript
// app/api/chat/route.ts
export const maxDuration = 60;

const result = streamText({
  // ...
  abortSignal: AbortSignal.timeout(60000),
  // ...
});
```

## 需要你手动处理的问题

### 🔧 2. 禁用干扰的浏览器扩展

**方法一: 临时禁用扩展测试**
1. 打开浏览器扩展管理页面
   - Chrome: `chrome://extensions/`
   - Edge: `edge://extensions/`
2. 逐个禁用扩展,测试问题是否解决
3. 找到导致问题的扩展后,考虑永久禁用或卸载

**方法二: 使用无痕/隐私模式**
在无痕模式下打开应用(扩展默认不会在无痕模式运行):
- Chrome/Edge: `Ctrl+Shift+N` (Windows) 或 `Cmd+Shift+N` (Mac)

**方法三: 为开发环境使用独立的浏览器配置文件**

### 🛡️ 3. 增加前端错误处理(可选)

如果希望更好地处理网络中断和超时,可以考虑在前端添加重试机制。

## 测试建议

1. **测试简单查询**
   ```
   你好,请介绍一下你自己
   ```
   
2. **测试复杂查询**
   ```
   详细分析一下当前人工智能的发展趋势
   ```

3. **测试联网搜索**
   - 启用"联网搜索"开关
   - 询问需要实时信息的问题
   ```
   今天的新闻有什么?
   ```

## 预期结果

- ✅ 流式输出应该流畅,不会中途卡住
- ✅ 复杂查询能在 60 秒内完成
- ✅ 如果禁用了干扰的扩展,不应再出现 403 错误

## 如果问题依然存在

检查以下几点:

1. **网络连接**
   - 确保网络稳定
   - 检查是否有防火墙或代理干扰

2. **API 提供商限制**
   - 检查 DeepSeek API 的速率限制
   - 查看 API 密钥是否有效

3. **服务器日志**
   ```bash
   # 查看服务器日志
   pnpm dev
   ```
   观察是否有错误信息

4. **数据库连接**
   - 确保 PostgreSQL 正常运行
   ```bash
   docker-compose ps
   ```

## 更多调试技巧

### 查看网络请求
1. 打开浏览器开发者工具 (F12)
2. 切换到 Network 标签
3. 筛选 "Fetch/XHR"
4. 发起一次对话
5. 查看 `/api/chat` 请求的状态和响应

### 查看控制台日志
1. 打开浏览器开发者工具 (F12)
2. 切换到 Console 标签
3. 清除旧日志
4. 发起一次对话
5. 查看是否有新的错误信息

## 联系支持

如果以上方案都无法解决问题,请提供:
- 浏览器版本
- 操作系统
- 完整的错误日志
- 服务器控制台输出



